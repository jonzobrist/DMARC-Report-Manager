#!/usr/bin/env bash

# import-dmarc: Upload DMARC report files to the DMARC Report Manager backend.
#
# Usage: ./import-dmarc <file-or-directory> [additional files...]
#
# If a directory is provided, all files inside it (non-recursive) will be uploaded.
# The script uses the backend API endpoint /api/upload (POST multipart/form-data).
#
# AUTHENTICATION (tried in order):
#   1. DMARC_API_KEY env var → X-API-Key header
#   2. DMARC_USERNAME + DMARC_PASSWORD env vars → JWT login
#   Set these in your environment or .env file.
#
# OPTIONS:
#   --api-url URL    Override the backend API URL (default: DMARC_API_URL or http://localhost:8000)

# Load .env if it exists in project root
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(dirname "$SCRIPT_DIR")"
if [ -f "$ROOT_DIR/.env" ]; then
  set -a
  source "$ROOT_DIR/.env"
  set +a
fi

API_BASE="${DMARC_API_URL:-${VITE_API_URL:-http://localhost:8000}}"
API_URL="${API_BASE%/}/api/upload"

print_usage() {
  echo "Usage: $0 [--api-url URL] <path> [more paths...]"
  echo "Each path can be a file or a directory. Directories are scanned for files (non-recursive)."
}

# Parse API URL if provided
TEMP_ARGS=()
while [[ $# -gt 0 ]]; do
  case $1 in
    --api-url)
      API_BASE="$2"
      API_URL="${API_BASE%/}/api/upload"
      shift 2
      ;;
    *)
      TEMP_ARGS+=("$1")
      shift
      ;;
  esac
done
set -- "${TEMP_ARGS[@]}"

if [[ $# -lt 1 ]]; then
  echo "Error: No files or directories specified."
  print_usage
  exit 1
fi

# Resolve auth - try API key first, then JWT login
AUTH_ARGS=()
if [[ -n "$DMARC_API_KEY" ]]; then
  AUTH_ARGS=(-H "X-API-Key: $DMARC_API_KEY")
  echo "Auth: Using API key"
elif [[ -n "$DMARC_USERNAME" && -n "$DMARC_PASSWORD" ]]; then
  echo "Auth: Logging in as $DMARC_USERNAME..."
  LOGIN_URL="${API_BASE%/}/api/login"
  login_response=$(curl -s -X POST "$LOGIN_URL" \
    -H "Content-Type: application/json" \
    -d "{\"username\":\"$DMARC_USERNAME\",\"password\":\"$DMARC_PASSWORD\"}")
  
  TOKEN=$(echo "$login_response" | grep -o '"access_token":"[^"]*"' | cut -d'"' -f4)
  if [[ -z "$TOKEN" ]]; then
    echo "Login failed: $login_response"
    exit 1
  fi
  AUTH_ARGS=(-H "Authorization: Bearer $TOKEN")
  echo "Auth: Login successful"
else
  echo "Warning: No auth configured. Set DMARC_API_KEY or DMARC_USERNAME+DMARC_PASSWORD in .env"
fi

upload_file() {
  local file="$1"
  if [[ ! -f "$file" ]]; then
    echo "Skipping '$file': not a regular file"
    return
  fi
  echo "Uploading '$file'..."
  response=$(curl -s -w "%{http_code}" "${AUTH_ARGS[@]}" -F "files=@${file}" "$API_URL")
  http_code="${response: -3}"
  body="${response:0:${#response}-3}"
  if [[ "$http_code" -ge 200 && "$http_code" -lt 300 ]]; then
    echo "Success: $file uploaded."
  else
    echo "Error uploading $file (HTTP $http_code): $body"
  fi
}

for path in "$@"; do
  if [[ -d "$path" ]]; then
    for f in "$path"/*; do
      [[ -e "$f" ]] || continue
      upload_file "$f"
    done
  else
    upload_file "$path"
  fi
done
