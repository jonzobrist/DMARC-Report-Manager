#!/bin/bash

# DMARC Report Manager - Service Management Script

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
SERVICE_NAME_BACKEND="dmarc-backend.service"
SERVICE_NAME_FRONTEND="dmarc-frontend.service"
BACKEND_TEMPLATE="${PROJECT_ROOT}/scripts/${SERVICE_NAME_BACKEND}"
FRONTEND_TEMPLATE="${PROJECT_ROOT}/scripts/${SERVICE_NAME_FRONTEND}"
SYSTEMD_PATH="/etc/systemd/system"

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

if [[ $EUID -ne 0 ]] && [[ "$1" == "install" || "$1" == "uninstall" ]]; then
   echo -e "${RED}This script must be run as root for install/uninstall.${NC}"
   exit 1
fi

load_config() {
    if [ -f "${PROJECT_ROOT}/.env" ]; then
        export $(grep -v '^#' "${PROJECT_ROOT}/.env" | xargs)
    fi
    APP_HOST="${APP_HOST:-127.0.0.1}"
    BACKEND_PORT="${BACKEND_PORT:-8000}"
    FRONTEND_PORT="${FRONTEND_PORT:-5173}"
}

install() {
    load_config
    echo "Installing services..."
    
    # Backend
    sed -e "s|USER_PLACEHOLDER|${SUDO_USER:-$USER}|g" \
        -e "s|PROJECT_ROOT_PLACEHOLDER|${PROJECT_ROOT}|g" \
        -e "s|APP_HOST_PLACEHOLDER|${APP_HOST}|g" \
        -e "s|BACKEND_PORT_PLACEHOLDER|${BACKEND_PORT}|g" \
        "${BACKEND_TEMPLATE}" > "${SYSTEMD_PATH}/${SERVICE_NAME_BACKEND}"
    
    # Frontend
    sed -e "s|USER_PLACEHOLDER|${SUDO_USER:-$USER}|g" \
        -e "s|PROJECT_ROOT_PLACEHOLDER|${PROJECT_ROOT}|g" \
        "${FRONTEND_TEMPLATE}" > "${SYSTEMD_PATH}/${SERVICE_NAME_FRONTEND}"
    
    systemctl daemon-reload
    systemctl enable "${SERVICE_NAME_BACKEND}"
    systemctl enable "${SERVICE_NAME_FRONTEND}"
    systemctl start "${SERVICE_NAME_BACKEND}"
    systemctl start "${SERVICE_NAME_FRONTEND}"
    
    echo -e "${GREEN}Services installed and started.${NC}"
}

uninstall() {
    echo "Uninstalling services..."
    systemctl stop "${SERVICE_NAME_BACKEND}" 2>/dev/null
    systemctl stop "${SERVICE_NAME_FRONTEND}" 2>/dev/null
    systemctl disable "${SERVICE_NAME_BACKEND}" 2>/dev/null
    systemctl disable "${SERVICE_NAME_FRONTEND}" 2>/dev/null
    rm -f "${SYSTEMD_PATH}/${SERVICE_NAME_BACKEND}"
    rm -f "${SYSTEMD_PATH}/${SERVICE_NAME_FRONTEND}"
    systemctl daemon-reload
    echo -e "${YELLOW}Services uninstalled.${NC}"
}

status() {
    echo "Service Status:"
    if [ -f "${SYSTEMD_PATH}/${SERVICE_NAME_BACKEND}" ]; then
        echo -e "Backend: ${GREEN}Installed${NC}"
        systemctl is-active "${SERVICE_NAME_BACKEND}" > /dev/null && echo -e "  Status: ${GREEN}Running${NC}" || echo -e "  Status: ${RED}Stopped${NC}"
    else
        echo -e "Backend: ${RED}Not installed${NC}"
    fi

    if [ -f "${SYSTEMD_PATH}/${SERVICE_NAME_FRONTEND}" ]; then
        echo -e "Frontend: ${GREEN}Installed${NC}"
        systemctl is-active "${SERVICE_NAME_FRONTEND}" > /dev/null && echo -e "  Status: ${GREEN}Running${NC}" || echo -e "  Status: ${RED}Stopped${NC}"
    else
        echo -e "Frontend: ${RED}Not installed${NC}"
    fi
}

case "$1" in
    install)
        install
        ;;
    uninstall)
        uninstall
        ;;
    status)
        status
        ;;
    *)
        echo "Usage: $0 {install|uninstall|status}"
        exit 1
        ;;
esac
