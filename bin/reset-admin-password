#!/usr/bin/env python3
import sqlite3
import bcrypt
import sys
import os

def reset_password(new_password):
    db_path = 'dmarc_reports.db'
    if not os.path.exists(db_path):
        print(f"Error: Database {db_path} not found.")
        sys.exit(1)
        
    conn = sqlite3.connect(db_path)
    c = conn.cursor()
    
    # Hash the new password
    hashed = bcrypt.hashpw(new_password.encode('utf-8'), bcrypt.gensalt()).decode('utf-8')
    
    # Check if admin user exists
    c.execute("SELECT id FROM users WHERE username = 'admin'")
    if not c.fetchone():
        print("Error: Admin user not found in database.")
        conn.close()
        sys.exit(1)
        
    # Update the password
    c.execute("UPDATE users SET password_hash = ? WHERE username = 'admin'", (hashed,))
    conn.commit()
    conn.close()
    print(f"Successfully reset admin password.")

if __name__ == "__main__":
    if len(sys.argv) > 1:
        new_pass = sys.argv[1]
    else:
        new_pass = "admin123"
        print(f"No password provided, defaulting to '{new_pass}'")
        
    reset_password(new_pass)
